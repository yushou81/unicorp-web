# 双师课堂数据库设计

## 1. 数据库概述

双师课堂功能的数据库设计需要支持课程管理、用户管理、报名管理、资源管理和评价管理等核心功能。本设计采用关系型数据库，所有表使用InnoDB引擎，以支持事务处理和外键约束。

## 2. 表结构设计

### 2.1 dual_teacher_course（双师课程表）

存储双师课堂的基本信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 课程ID |
| title | VARCHAR(100) | NOT NULL | 课程标题 |
| description | TEXT | | 课程描述 |
| teacher_id | BIGINT | NOT NULL, FK | 教师ID，关联user表 |
| mentor_id | BIGINT | NOT NULL, FK | 企业导师ID，关联user表 |
| scheduled_time | DATETIME | NOT NULL | 课程计划时间 |
| max_students | INT | NOT NULL DEFAULT 30 | 最大学生人数 |
| location | VARCHAR(200) | | 上课地点 |
| course_type | VARCHAR(20) | NOT NULL | 课程类型：online/offline/hybrid |
| status | VARCHAR(20) | NOT NULL DEFAULT 'planning' | 课程状态：planning/open/in_progress/completed/cancelled |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted | BOOLEAN | NOT NULL DEFAULT FALSE | 逻辑删除标记 |

**索引**：
- 主键索引：`id`
- 外键索引：`teacher_id`, `mentor_id`
- 组合索引：`(status, course_type)` 用于课程列表筛选

### 2.2 course_enrollment（课程报名表）

记录学生报名课程的信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 报名记录ID |
| course_id | BIGINT | NOT NULL, FK | 课程ID，关联dual_teacher_course表 |
| student_id | BIGINT | NOT NULL, FK | 学生ID，关联user表 |
| enroll_time | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 报名时间 |
| status | VARCHAR(20) | NOT NULL DEFAULT 'enrolled' | 状态：enrolled/completed/cancelled |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- 主键索引：`id`
- 外键索引：`course_id`, `student_id`
- 唯一索引：`(course_id, student_id)` 防止重复报名
- 组合索引：`(student_id, status)` 用于查询学生已报名课程

### 2.3 course_resource（课程资源表）

存储课程相关的资源文件信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 资源ID |
| course_id | BIGINT | NOT NULL, FK | 课程ID，关联dual_teacher_course表 |
| uploader_id | BIGINT | NOT NULL, FK | 上传者ID，关联user表 |
| title | VARCHAR(100) | NOT NULL | 资源标题 |
| description | TEXT | | 资源描述 |
| resource_type | VARCHAR(20) | NOT NULL | 资源类型：document/video/code/other |
| file_url | VARCHAR(500) | NOT NULL | 文件URL |
| file_size | BIGINT | NOT NULL | 文件大小（字节） |
| download_count | INT | NOT NULL DEFAULT 0 | 下载次数 |
| upload_time | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 上传时间 |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted | BOOLEAN | NOT NULL DEFAULT FALSE | 逻辑删除标记 |

**索引**：
- 主键索引：`id`
- 外键索引：`course_id`, `uploader_id`
- 组合索引：`(course_id, resource_type)` 用于按类型查询课程资源

### 2.4 course_chapter（课程章节表）

存储课程的章节信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 章节ID |
| course_id | BIGINT | NOT NULL, FK | 课程ID，关联dual_teacher_course表 |
| title | VARCHAR(100) | NOT NULL | 章节标题 |
| description | TEXT | | 章节描述 |
| sort | INT | NOT NULL DEFAULT 0 | 排序顺序 |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted | BOOLEAN | NOT NULL DEFAULT FALSE | 逻辑删除标记 |

**索引**：
- 主键索引：`id`
- 外键索引：`course_id`
- 组合索引：`(course_id, sort)` 用于按顺序查询章节

### 2.5 chapter_resource（章节资源关联表）

关联章节和资源的中间表。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 关联ID |
| chapter_id | BIGINT | NOT NULL, FK | 章节ID，关联course_chapter表 |
| resource_id | BIGINT | NOT NULL, FK | 资源ID，关联course_resource表 |
| sort | INT | NOT NULL DEFAULT 0 | 排序顺序 |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- 主键索引：`id`
- 外键索引：`chapter_id`, `resource_id`
- 唯一索引：`(chapter_id, resource_id)` 防止重复关联
- 组合索引：`(chapter_id, sort)` 用于按顺序查询章节资源

### 2.6 course_rating（课程评价表）

存储学生对课程的评价信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 评价ID |
| course_id | BIGINT | NOT NULL, FK | 课程ID，关联dual_teacher_course表 |
| student_id | BIGINT | NOT NULL, FK | 学生ID，关联user表 |
| rating | TINYINT | NOT NULL, CHECK(rating BETWEEN 1 AND 5) | 评分（1-5） |
| content | TEXT | | 评价内容 |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- 主键索引：`id`
- 外键索引：`course_id`, `student_id`
- 唯一索引：`(course_id, student_id)` 每个学生只能评价一次
- 组合索引：`(course_id, rating)` 用于查询课程评分

### 2.7 student_progress（学生学习进度表）

记录学生的学习进度信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 进度记录ID |
| enrollment_id | BIGINT | NOT NULL, FK | 报名记录ID，关联course_enrollment表 |
| chapter_id | BIGINT | NOT NULL, FK | 章节ID，关联course_chapter表 |
| status | VARCHAR(20) | NOT NULL DEFAULT 'not_started' | 状态：not_started/in_progress/completed |
| progress_percentage | DECIMAL(5,2) | NOT NULL DEFAULT 0 | 进度百分比 |
| last_access_time | DATETIME | | 最后访问时间 |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- 主键索引：`id`
- 外键索引：`enrollment_id`, `chapter_id`
- 唯一索引：`(enrollment_id, chapter_id)` 每个学生在每个章节只有一条进度记录
- 组合索引：`(enrollment_id, status)` 用于查询学生的学习状态

### 2.8 resource_access_log（资源访问日志表）

记录学生访问资源的历史记录。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 日志ID |
| resource_id | BIGINT | NOT NULL, FK | 资源ID，关联course_resource表 |
| student_id | BIGINT | NOT NULL, FK | 学生ID，关联user表 |
| access_type | VARCHAR(20) | NOT NULL | 访问类型：view/download |
| access_time | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 访问时间 |
| ip_address | VARCHAR(50) | | 访问IP地址 |
| user_agent | VARCHAR(200) | | 用户代理信息 |

**索引**：
- 主键索引：`id`
- 外键索引：`resource_id`, `student_id`
- 组合索引：`(student_id, access_time)` 用于查询学生的访问历史
- 组合索引：`(resource_id, access_time)` 用于查询资源的访问历史

## 3. 表关系设计

### 3.1 外键关系

1. **dual_teacher_course表**
   - `teacher_id` 外键关联 `user表`
   - `mentor_id` 外键关联 `user表`

2. **course_enrollment表**
   - `course_id` 外键关联 `dual_teacher_course表`
   - `student_id` 外键关联 `user表`

3. **course_resource表**
   - `course_id` 外键关联 `dual_teacher_course表`
   - `uploader_id` 外键关联 `user表`

4. **course_chapter表**
   - `course_id` 外键关联 `dual_teacher_course表`

5. **chapter_resource表**
   - `chapter_id` 外键关联 `course_chapter表`
   - `resource_id` 外键关联 `course_resource表`

6. **course_rating表**
   - `course_id` 外键关联 `dual_teacher_course表`
   - `student_id` 外键关联 `user表`

7. **student_progress表**
   - `enrollment_id` 外键关联 `course_enrollment表`
   - `chapter_id` 外键关联 `course_chapter表`

8. **resource_access_log表**
   - `resource_id` 外键关联 `course_resource表`
   - `student_id` 外键关联 `user表`

### 3.2 E-R图

以下是简化的实体关系图表示：

```
+-----------------+       +-------------------+       +---------------+
| User            |       | DualTeacherCourse |       | CourseChapter |
|                 |<------|                   |------>|               |
| (teacher,       |       | (course info,     |       | (chapter info,|
|  mentor,        |       |  status, etc)     |       |  sort order)  |
|  student)       |       |                   |       |               |
+-----------------+       +-------------------+       +---------------+
        ^                          ^                         ^
        |                          |                         |
        |                          |                         |
        v                          v                         v
+-----------------+       +-------------------+       +---------------+
| CourseEnrollment|       | CourseResource    |       | ChapterResource|
|                 |       |                   |       |               |
| (enrollment     |       | (resource files,  |       | (association  |
|  records)       |       |  metadata)        |       |  table)       |
+-----------------+       +-------------------+       +---------------+
        ^                          ^
        |                          |
        |                          |
        v                          v
+-----------------+       +-------------------+
| StudentProgress |       | ResourceAccessLog |
|                 |       |                   |
| (learning       |       | (access history,  |
|  progress)      |       |  statistics)      |
+-----------------+       +-------------------+
        ^
        |
        |
        v
+-----------------+
| CourseRating    |
|                 |
| (student        |
|  reviews)       |
+-----------------+
```

## 4. 数据库优化策略

### 4.1 索引优化

1. **适当使用联合索引**：根据查询模式创建复合索引，如`(course_id, resource_type)`

2. **避免过度索引**：只为频繁查询的字段创建索引，避免影响写入性能

3. **选择合适的索引类型**：使用B-Tree索引作为主要索引类型

### 4.2 查询优化

1. **分页查询优化**：使用主键范围分页代替OFFSET分页，如：
   ```sql
   SELECT * FROM dual_teacher_course 
   WHERE id > last_id AND status = 'open' 
   ORDER BY id ASC LIMIT 10
   ```

2. **延迟关联**：先查询主键，再关联详细信息，如：
   ```sql
   SELECT c.* FROM dual_teacher_course c
   JOIN (
     SELECT id FROM dual_teacher_course 
     WHERE status = 'open' 
     LIMIT 10
   ) AS t ON c.id = t.id
   ```

3. **使用覆盖索引**：确保查询只使用索引中的字段，如：
   ```sql
   SELECT id, title, scheduled_time, status 
   FROM dual_teacher_course
   WHERE course_type = 'online' AND status = 'open'
   ```

### 4.3 表设计优化

1. **适当冗余**：适当冗余一些频繁查询的字段，如在course_enrollment表中冗余course_title

2. **大字段分离**：将TEXT类型的大字段放在单独的表中，如课程的详细描述

3. **使用合适的数据类型**：使用最小满足需求的数据类型，如使用TINYINT而不是INT存储评分

### 4.4 读写分离和分库分表

对于大规模应用，考虑以下策略：

1. **读写分离**：主库负责写操作，从库负责读操作

2. **垂直分表**：按照功能将大表拆分为多个小表，如将课程资源分离

3. **水平分表**：按照一定规则（如课程ID范围）将数据分散到多个表中

## 5. 数据库脚本示例

### 5.1 创建表脚本示例

```sql
-- 创建双师课程表
CREATE TABLE dual_teacher_course (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    teacher_id BIGINT NOT NULL,
    mentor_id BIGINT NOT NULL,
    scheduled_time DATETIME NOT NULL,
    max_students INT NOT NULL DEFAULT 30,
    location VARCHAR(200),
    course_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'planning',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted BOOLEAN NOT NULL DEFAULT FALSE,
    CONSTRAINT fk_course_teacher FOREIGN KEY (teacher_id) REFERENCES user(id),
    CONSTRAINT fk_course_mentor FOREIGN KEY (mentor_id) REFERENCES user(id),
    INDEX idx_course_status_type (status, course_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建课程报名表
CREATE TABLE course_enrollment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    course_id BIGINT NOT NULL,
    student_id BIGINT NOT NULL,
    enroll_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) NOT NULL DEFAULT 'enrolled',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT fk_enrollment_course FOREIGN KEY (course_id) REFERENCES dual_teacher_course(id),
    CONSTRAINT fk_enrollment_student FOREIGN KEY (student_id) REFERENCES user(id),
    UNIQUE INDEX uk_course_student (course_id, student_id),
    INDEX idx_student_status (student_id, status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建课程资源表
CREATE TABLE course_resource (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    course_id BIGINT NOT NULL,
    uploader_id BIGINT NOT NULL,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    resource_type VARCHAR(20) NOT NULL,
    file_url VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    download_count INT NOT NULL DEFAULT 0,
    upload_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted BOOLEAN NOT NULL DEFAULT FALSE,
    CONSTRAINT fk_resource_course FOREIGN KEY (course_id) REFERENCES dual_teacher_course(id),
    CONSTRAINT fk_resource_uploader FOREIGN KEY (uploader_id) REFERENCES user(id),
    INDEX idx_course_type (course_id, resource_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 5.2 视图示例

```sql
-- 创建课程基本信息视图
CREATE VIEW v_course_info AS
SELECT 
    c.id,
    c.title,
    c.description,
    c.teacher_id,
    t.nickname AS teacher_name,
    c.mentor_id,
    m.nickname AS mentor_name,
    m.organization_name AS enterprise_name,
    c.scheduled_time,
    c.max_students,
    (SELECT COUNT(*) FROM course_enrollment WHERE course_id = c.id AND status = 'enrolled') AS enrolled_count,
    c.location,
    c.course_type,
    c.status,
    c.created_at
FROM 
    dual_teacher_course c
JOIN 
    user t ON c.teacher_id = t.id
JOIN 
    user m ON c.mentor_id = m.id
WHERE 
    c.deleted = FALSE;

-- 创建课程评分统计视图
CREATE VIEW v_course_rating AS
SELECT 
    course_id,
    COUNT(*) AS rating_count,
    AVG(rating) AS average_rating,
    MIN(rating) AS min_rating,
    MAX(rating) AS max_rating
FROM 
    course_rating
GROUP BY 
    course_id;
```

### 5.3 存储过程示例

```sql
-- 学生报名课程存储过程
DELIMITER //
CREATE PROCEDURE sp_enroll_course(
    IN p_student_id BIGINT,
    IN p_course_id BIGINT,
    OUT p_result INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_course_status VARCHAR(20);
    DECLARE v_enrolled_count INT;
    DECLARE v_max_students INT;
    DECLARE v_existing_count INT;
    
    -- 默认为失败
    SET p_result = 0;
    SET p_message = 'Unknown error';
    
    START TRANSACTION;
    
    -- 检查课程状态
    SELECT status, max_students INTO v_course_status, v_max_students
    FROM dual_teacher_course
    WHERE id = p_course_id AND deleted = FALSE
    FOR UPDATE;
    
    IF v_course_status IS NULL THEN
        SET p_message = 'Course not found or deleted';
        ROLLBACK;
    ELSEIF v_course_status != 'open' THEN
        SET p_message = 'Course is not open for enrollment';
        ROLLBACK;
    ELSE
        -- 检查是否已报名
        SELECT COUNT(*) INTO v_existing_count
        FROM course_enrollment
        WHERE course_id = p_course_id AND student_id = p_student_id;
        
        IF v_existing_count > 0 THEN
            SET p_message = 'Student has already enrolled in this course';
            ROLLBACK;
        ELSE
            -- 检查人数是否已满
            SELECT COUNT(*) INTO v_enrolled_count
            FROM course_enrollment
            WHERE course_id = p_course_id AND status = 'enrolled';
            
            IF v_enrolled_count >= v_max_students THEN
                SET p_message = 'Course is full';
                ROLLBACK;
            ELSE
                -- 创建报名记录
                INSERT INTO course_enrollment(course_id, student_id)
                VALUES(p_course_id, p_student_id);
                
                -- 为每个章节创建进度记录
                INSERT INTO student_progress(enrollment_id, chapter_id, status)
                SELECT LAST_INSERT_ID(), id, 'not_started'
                FROM course_chapter
                WHERE course_id = p_course_id AND deleted = FALSE;
                
                SET p_result = 1;
                SET p_message = 'Enrolled successfully';
                COMMIT;
            END IF;
        END IF;
    END IF;
END //
DELIMITER ;
```

## 6. 数据库安全考虑

### 6.1 数据安全策略

1. **敏感信息加密**：对敏感信息如用户联系方式进行加密存储

2. **权限管理**：对不同角色（教师、学生、导师）设置不同的数据库访问权限

3. **SQL注入防护**：使用参数化查询，避免SQL注入风险

4. **数据备份**：定期备份数据库，并测试恢复流程

### 6.2 审计日志

创建数据库审计日志表，记录关键操作：

```sql
CREATE TABLE db_audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    action VARCHAR(50) NOT NULL,
    table_name VARCHAR(50) NOT NULL,
    record_id BIGINT,
    old_data JSON,
    new_data JSON,
    ip_address VARCHAR(50),
    action_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 7. 数据迁移与版本控制

### 7.1 迁移策略

使用迁移脚本管理数据库版本，每次结构变更创建迁移脚本：

```sql
-- 迁移示例：添加课程封面图片字段
-- 版本: V1.2.0
-- 日期: 2023-06-15

ALTER TABLE dual_teacher_course
ADD COLUMN cover_image_url VARCHAR(500) AFTER description;

-- 回滚脚本
-- ALTER TABLE dual_teacher_course DROP COLUMN cover_image_url;
```

### 7.2 版本控制

使用版本控制表记录数据库版本：

```sql
CREATE TABLE db_version (
    id INT PRIMARY KEY AUTO_INCREMENT,
    version VARCHAR(20) NOT NULL,
    applied_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    description VARCHAR(200)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO db_version(version, description) VALUES('1.0.0', 'Initial schema');
```

## 8. 总结

本数据库设计为双师课堂功能提供了完善的数据存储和管理方案，包含8个核心表：双师课程表、课程报名表、课程资源表、课程章节表、章节资源关联表、课程评价表、学生学习进度表和资源访问日志表。

设计考虑了数据完整性、查询效率和安全性，采用了适当的索引策略、外键约束和数据类型选择。同时，提供了视图和存储过程示例，以简化常见的数据操作。

对于大规模应用，本设计也提供了优化建议，包括读写分离、分库分表和查询优化策略。数据库版本控制和迁移策略确保了数据库结构能够随着应用需求的变化而有序演进。 